{% extends "hq/base.html" %}
{% load i18n %}
{% load notification-tags %}
{% load pagination-tags %}
{% load wqm-tags %}

{% block title %}{% trans "SamplingPoints Map" %}{% endblock %}
{% block javascripts %}
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAAwLx05eiFcJGGICFj_Nm3yxSy7OMGWhZNIeCBzFBsFwAAIleLbBRLVT87XVW-AJJ4ZR3UOs3-8BnQ-A"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}/graphing/flot/jquery.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}/graphing/flot/jquery.flot.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}/aquatest/js/selector.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/hq/javascripts/jquery-1.3.2.min.js"></script>
<!--Map specific script... later moved to it's own file-->
<script>
var samplingpointByID = {};
{% for samplingpoint in samplingpoints %}
	samplingpointByID[{{samplingpoint.id}}] = {"name: "{{samplingpoint.name}}", lat: {{samplingpoint.point.y}}, lng: {{samplingpoint.point.x}}};
{% endfor %}

var map, marker, geocoder, current_object;

function initialize() {
	if (GBrowserIsCompatible()) {
		map = new GMap2(document.getElementById('map'));
		map.setCenter(new GLatLng(-29.000000, 24.000000), 5);
		map.setUIToDefault();
		geocoder = new GClientGeocoder();
		
		var blueIcon = new GIcon(G_DEFAULT_ICON);
		blueIcon.image = "http://maps.google.com/intl/en_us/mapfiles/ms/micons/green-dot.png";
           
		// Set up our GMarkerOptions object
		markerOptions = { icon:blueIcon };
  
		for(var pointI in samplingpointByID) {
			var samplePoint = samplingpointByID[pointI];
			var point = new GLatLng(samplePoint.lat, samplePoint.lng);
			marker = new GMarker(point,markerOptions);
			map.addOverlay(marker);
		}
	}
}

$(document).ready(function () {
    function activate_samplingpoints() {
        // Add samplingpoint click handler
        $('.samplingpoint').each(function () {
            $(this).click(function() {
                var samplingpoint = samplingpointByID[this.id];
                var center = new GLatLng(samplingpoint.lat, samplingpoint.lng);
                current_object = $(this);
                if (marker) map.removeOverlay(marker);
                marker = new GMarker(center, {draggable: false});
                GEvent.addListener(marker, "dragend", function() {
                    var latlng = marker.getLatLng();
                    samplingpoint.lat = latlng.lat();
                    samplingpoint.lng = latlng.lng();
                    current_object.html(samplingpoint.name + ' (' + samplingpoint.lat + ', ' + samplingpoint.lng + ')');
                    $('#button_save').removeAttr("disabled");
                });
                map.addOverlay(marker);
                map.panTo(center);
var markerOffset = map.fromLatLngToDivPixel(marker.getPoint());
// add innerHTML in the #message before showing the #message
content = samplingpoint.name;
$("#message").html(content);
$("#message").show();
            }).hover(
                function () {this.className = this.className.replace('OFF', 'ON');},
                function () {this.className = this.className.replace('ON', 'OFF');}
            );
        });
    }

    activate_samplingpoints();
});
</script>

<style>
    body {
        font-family: sans-serif;
    }
    #map {
        width: 600px;
        height: 400px;
border: 1px solid #999;
margin: 0 auto;
    }
    #samplingpoints {
        overflow: auto;
        width: 500px;
        height: 100px;
    }
    .linkOFF {color: darkblue}
    .linkON {color: white; background-color: darkblue}
    #message { float:right; padding:10px; background:#555; color:#fff; width:75px; }
</style>

{% endblock %}


{% block content %}
<body onload="initialize()" onunload="GUnload()">
<div id="subheading">
	<ul>
		<li><a href="{% url wqm.views.index %}"><b>Sampling Point</b></a></li>
		<li><a href="{% url wqm.views.mapindex %}"><b>Sampling Point Map</b></a></li>
		<li>&nbsp;</li>
	</ul> 
</div>
<div>
  <form action='#' method='POST'>
    <h3>Sample taken between
	{{ form.startdate }}
      and
	{{ form.enddate }}
	<input type='checkbox' value='failure' name="failure" /> Show failures only
    	<input type='submit' value='Filter' />
    </h3>
  </form>
</div>

<div id="message"style="display:none;"> Area- Point: Samples 12 </div>
<div id=map></div>
<div id=samplingpoints>
    <p>Jump to Sampling Point </p>
    {{content}}
</div>

</body>
{% endblock %}